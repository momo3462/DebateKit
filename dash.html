<!DOCTYPE html>
<html lang="it">
<head>
    <script src="core-manager.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dash - Debate Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700;800&family=Inter:wght@400;700&family=Playfair+Display:wght@700&family=Fira+Code&display=swap');

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: #f0fdf4;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            margin: 0;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        body.loaded { opacity: 1; }

        #canvas-container {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: auto;
            background-image: radial-gradient(#d1fae5 2px, transparent 2px);
            background-size: 40px 40px;
            cursor: crosshair;
            scroll-behavior: smooth;
        }

        #dashboard-canvas {
            min-width: 5000px;
            min-height: 5000px;
            position: relative;
            transform-origin: 0 0;
        }

        .dash-box {
            position: absolute;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.06);
            border: 2px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            z-index: 10;
            transition: border-color 0.2s, box-shadow 0.2s, transform 0.2s ease;
        }

        .dash-box:hover { transform: translateY(-2px); }

        .dash-box.selected {
            border-color: #10b981;
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.15);
            z-index: 100 !important;
            transform: scale(1.01);
        }

        .box-author-tag {
            position: absolute;
            top: -10px;
            right: 12px;
            background: #10b981;
            color: white;
            font-size: 10px;
            font-weight: 800;
            padding: 2px 8px;
            border-radius: 20px;
            text-transform: uppercase;
            box-shadow: 0 4px 10px rgba(16, 185, 129, 0.2);
            pointer-events: none;
        }

        .box-toolbar {
            position: absolute;
            bottom: calc(100% + 12px);
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 6px;
            border-radius: 14px;
            display: none;
            gap: 6px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            white-space: nowrap;
            z-index: 1001;
            border: 1px solid #f1f5f9;
            animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes popIn {
            from { opacity: 0; transform: translateX(-50%) scale(0.8); }
            to { opacity: 1; transform: translateX(-50%) scale(1); }
        }

        .dash-box.selected .box-toolbar { display: flex; }

        .toolbar-tool {
            padding: 6px 10px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 700;
            color: #475569;
            border: 1px solid #f1f5f9;
            display: flex;
            align-items: center;
            gap: 4px;
            background: #fff;
            cursor: pointer;
        }
        .toolbar-tool:hover { background: #f0fdf4; color: #10b981; border-color: #10b981; }

        .box-content {
            padding: 16px;
            flex-grow: 1;
            outline: none;
            overflow: hidden;
            min-height: 80px;
            cursor: text;
            font-size: 14px;
            line-height: 1.5;
        }

        .drag-handle {
            height: 24px;
            width: 100%;
            cursor: move;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .drag-handle::after {
            content: ''; width: 30px; height: 4px; background: #e2e8f0; border-radius: 2px;
        }

        .resize-handle {
            position: absolute; width: 18px; height: 18px; background: #10b981;
            right: -2px; bottom: -2px; border-radius: 6px 0 16px 0;
            cursor: nwse-resize; z-index: 110;
        }

        #timer-widget {
            position: fixed; top: 1.5rem; right: 1.5rem;
            background: white; padding: 1rem; border-radius: 1.5rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            display: flex; align-items: center; gap: 1rem; z-index: 1000;
            border: 1px solid #e2e8f0;
        }

        #connections-svg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 5;
        }

        .connector-line { 
            fill: none; stroke: #10b981; stroke-width: 3; 
            stroke-linecap: round; marker-end: url(#arrowhead);
            transition: d 0.2s ease;
        }

        .side-controls {
            position: fixed; top: 50%; right: 1.5rem; transform: translateY(-50%);
            background: white; padding: 0.6rem; border-radius: 1.5rem;
            display: flex; flex-direction: column; gap: 0.6rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05); z-index: 200;
        }

        .control-btn {
            width: 46px; height: 46px; border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s; color: #64748b; background: #fff;
        }
        .control-btn:hover { background: #f0fdf4; color: #10b981; transform: scale(1.1); }
        .control-btn.active { background: #10b981; color: white; }

        .toolbar-dock {
            position: fixed; bottom: 1.5rem; left: 50%; transform: translateX(-50%);
            z-index: 200; padding: 0.6rem; border-radius: 2rem;
            display: flex; align-items: center; gap: 0.5rem;
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(15px);
            border: 1px solid rgba(16, 185, 129, 0.2); box-shadow: 0 15px 45px rgba(0,0,0,0.12);
        }

        .nav-item {
            display: flex; align-items: center; gap: 0.6rem;
            padding: 0.7rem 1.2rem; border-radius: 1.5rem;
            color: #64748b; font-weight: 700; font-size: 0.85rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .nav-item:hover { color: #10b981; background: rgba(16, 185, 129, 0.08); transform: translateY(-2px); }
        .nav-item.active { background: white; color: #10b981; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.15); }
    </style>
</head>
<body class="loaded">

    <!-- Timer -->
    <div id="timer-widget">
        <div class="flex flex-col">
            <span class="text-[10px] font-black uppercase text-emerald-600 tracking-widest">Tempo Rimasto</span>
            <div id="timer-display" class="text-2xl font-mono font-bold text-slate-800">00:00</div>
        </div>
        <div class="flex gap-2">
            <button onclick="toggleTimer()" id="timer-btn" class="w-10 h-10 flex items-center justify-center bg-emerald-500 text-white rounded-full shadow-lg shadow-emerald-100 transition-transform active:scale-90">
                <i data-lucide="play" class="w-5 h-5"></i>
            </button>
            <button onclick="resetTimer()" class="w-10 h-10 flex items-center justify-center bg-slate-100 text-slate-500 rounded-full transition-transform active:scale-90">
                <i data-lucide="rotate-ccw" class="w-5 h-5"></i>
            </button>
        </div>
    </div>

    <!-- Canvas -->
    <div id="canvas-container" onmousedown="handleCanvasClick(event)">
        <div id="dashboard-canvas">
            <svg id="connections-svg">
                <defs>
                    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#10b981" />
                    </marker>
                </defs>
            </svg>
        </div>
    </div>

    <!-- Floating Actions -->
    <div class="side-controls">
        <button onclick="addBox('text')" class="control-btn" title="Nuovo Appunto"><i data-lucide="plus"></i></button>
        <button onclick="triggerFile()" class="control-btn" title="Allega File"><i data-lucide="paperclip"></i></button>
        <button onclick="toggleDrawMode()" id="draw-btn" class="control-btn" title="Crea Collegamento"><i data-lucide="share-2"></i></button>
        <div class="h-px bg-slate-100 mx-2"></div>
        <button onclick="deleteSelected()" class="control-btn text-rose-500 hover:bg-rose-50" title="Elimina Selezione"><i data-lucide="trash-2"></i></button>
    </div>

    <!-- Navigation -->
    <nav class="toolbar-dock">
        <div class="p-2.5 bg-emerald-500 rounded-xl text-white mr-1 shadow-lg shadow-emerald-100">
            <i data-lucide="layout" class="w-5 h-5"></i>
        </div>
        <a href="index.html" class="nav-item"><i data-lucide="home" class="w-4 h-4"></i> Home</a>
        <a href="advi.html" class="nav-item"><i data-lucide="info" class="w-4 h-4"></i> Advisor</a>
        <a href="dash.html" class="nav-item active"><i data-lucide="layout" class="w-4 h-4"></i> Dash</a>
        <a href="tuth.html" class="nav-item"><i data-lucide="message-square" class="w-4 h-4"></i> Tutor</a>
        <div class="w-px h-6 bg-slate-200 mx-1"></div>
        <button onclick="CoreManager.logout()" class="nav-item text-rose-500"><i data-lucide="log-out" class="w-4 h-4"></i> Esci</button>
    </nav>

    <input type="file" id="file-input" class="hidden" onchange="handleFile(event)">

    <script>
        let boxes = [];
        let connections = [];
        let selectedId = null;
        let isDrawing = false;
        let drawFrom = null;
        let lastSyncTime = 0;

        let dragInfo = null;
        let resizeInfo = null;

        const SYNC_URL = window.location.origin + '/api/sync'; 
        const canvas = document.getElementById('dashboard-canvas');
        const svg = document.getElementById('connections-svg');

        window.onload = () => {
            document.body.classList.add('loaded');
            lucide.createIcons();
            loadState(); 
            startPolling(); 
            document.addEventListener('mousemove', handleGlobalMove);
            document.addEventListener('mouseup', handleGlobalUp);
        };

        function addBox(type, x = 250, y = 250, content = '') {
            // Verifica che CoreManager sia disponibile e l'utente sia loggato
            const user = window.CoreManager ? window.CoreManager.user : null;
            const id = 'box_' + Date.now();
            const box = { 
                id, type, x, y, w: 280, h: 160, 
                content: content || 'Scrivi qui...', 
                color: '#ffffff', font: 'Plus Jakarta Sans', 
                weight: 'normal', style: 'normal',
                author: user ? user.username : 'Debater'
            };
            boxes.push(box);
            renderBox(box);
            saveState();
        }

        function renderBox(data) {
            let el = document.getElementById(data.id);
            if (!el) {
                el = document.createElement('div');
                el.id = data.id;
                canvas.appendChild(el);
            }

            el.className = 'dash-box' + (selectedId === data.id ? ' selected' : '');
            el.style.left = data.x + 'px';
            el.style.top = data.y + 'px';
            el.style.width = data.w + 'px';
            el.style.height = data.h + 'px';
            el.style.backgroundColor = data.color;

            el.innerHTML = `
                <div class="drag-handle" onmousedown="initDrag(event, '${data.id}')"></div>
                <div class="box-author-tag">${data.author || 'Debater'}</div>
                <div class="box-toolbar">
                    <select onchange="updateBoxStyle('${data.id}', 'font', this.value)" class="toolbar-tool">
                        <option value="Plus Jakarta Sans" ${data.font === 'Plus Jakarta Sans' ? 'selected' : ''}>Sans</option>
                        <option value="Inter" ${data.font === 'Inter' ? 'selected' : ''}>Inter</option>
                        <option value="Playfair Display" ${data.font === 'Playfair Display' ? 'selected' : ''}>Serif</option>
                        <option value="Fira Code" ${data.font === 'Fira Code' ? 'selected' : ''}>Mono</option>
                    </select>
                    <button onclick="updateBoxStyle('${data.id}', 'weight')" class="toolbar-tool"><i data-lucide="bold" class="w-3.5 h-3.5"></i></button>
                    <button onclick="updateBoxStyle('${data.id}', 'style')" class="toolbar-tool"><i data-lucide="italic" class="w-3.5 h-3.5"></i></button>
                    <button onclick="updateBoxStyle('${data.id}', 'color')" class="toolbar-tool"><i data-lucide="palette" class="w-3.5 h-3.5"></i></button>
                </div>
                <div class="box-content" contenteditable="true" 
                     style="font-family: '${data.font}'; font-weight: ${data.weight}; font-style: ${data.style};"
                     oninput="updateContent('${data.id}', this.innerHTML)"
                     onmousedown="event.stopPropagation()">
                    ${data.content}
                </div>
                <div class="resize-handle" onmousedown="initResize(event, '${data.id}')"></div>
            `;

            el.onmousedown = (e) => {
                if (isDrawing) {
                    e.preventDefault();
                    e.stopPropagation();
                    connect(data.id);
                } else {
                    selectedId = data.id;
                    updateUI();
                }
            };

            lucide.createIcons();
        }

        // Logica Drag, Resize, Connection, Timer (Invariata)
        function initDrag(e, id) { e.preventDefault(); e.stopPropagation(); const box = boxes.find(b => b.id === id); dragInfo = { id, startX: e.clientX, startY: e.clientY, initialX: box.x, initialY: box.y }; selectedId = id; updateUI(); }
        function initResize(e, id) { e.preventDefault(); e.stopPropagation(); const box = boxes.find(b => b.id === id); resizeInfo = { id, startX: e.clientX, startY: e.clientY, initialW: box.w, initialH: box.h }; }
        function handleGlobalMove(e) {
            if (dragInfo) {
                const box = boxes.find(b => b.id === dragInfo.id);
                box.x = dragInfo.initialX + (e.clientX - dragInfo.startX);
                box.y = dragInfo.initialY + (e.clientY - dragInfo.startY);
                const el = document.getElementById(dragInfo.id);
                el.style.left = box.x + 'px'; el.style.top = box.y + 'px';
                updateConnections();
            }
            if (resizeInfo) {
                const box = boxes.find(b => b.id === resizeInfo.id);
                box.w = Math.max(150, resizeInfo.initialW + (e.clientX - resizeInfo.startX));
                box.h = Math.max(80, resizeInfo.initialH + (e.clientY - resizeInfo.startY));
                const el = document.getElementById(resizeInfo.id);
                el.style.width = box.w + 'px'; el.style.height = box.h + 'px';
                updateConnections();
            }
        }
        function handleGlobalUp() { if (dragInfo || resizeInfo) saveState(); dragInfo = null; resizeInfo = null; }
        function handleCanvasClick(e) { if (e.target.id === 'canvas-container' || e.target.id === 'dashboard-canvas') { selectedId = null; updateUI(); } }
        function updateUI() { document.querySelectorAll('.dash-box').forEach(b => b.classList.toggle('selected', b.id === selectedId)); }
        function updateBoxStyle(id, prop, value) {
            const box = boxes.find(b => b.id === id);
            const el = document.getElementById(id);
            const contentEl = el.querySelector('.box-content');
            if (prop === 'font') { box.font = value; contentEl.style.fontFamily = value; } 
            else if (prop === 'weight') { box.weight = box.weight === 'bold' ? 'normal' : 'bold'; contentEl.style.fontWeight = box.weight; } 
            else if (prop === 'style') { box.style = box.style === 'italic' ? 'normal' : 'italic'; contentEl.style.fontStyle = box.style; } 
            else if (prop === 'color') { const colors = ['#ffffff', '#fffbeb', '#f0fdf4', '#eff6ff', '#fdf2f8']; box.color = colors[(colors.indexOf(box.color) + 1) % colors.length]; el.style.backgroundColor = box.color; }
            saveState();
        }
        function toggleDrawMode() { isDrawing = !isDrawing; document.getElementById('draw-btn').classList.toggle('active', isDrawing); drawFrom = null; }
        function connect(id) {
            if (!drawFrom) { drawFrom = id; document.getElementById(id).style.borderColor = '#10b981'; } 
            else {
                if (drawFrom !== id) {
                    const exists = connections.some(c => (c.from === drawFrom && c.to === id) || (c.from === id && c.to === drawFrom));
                    if(!exists) { connections.push({ from: drawFrom, to: id }); updateConnections(); saveState(); }
                }
                document.getElementById(drawFrom).style.borderColor = '';
                drawFrom = null; toggleDrawMode();
            }
        }
        function updateConnections() {
            svg.querySelectorAll('.connector-line').forEach(l => l.remove());
            connections.forEach(conn => {
                const b1 = boxes.find(b => b.id === conn.from);
                const b2 = boxes.find(b => b.id === conn.to);
                if (!b1 || !b2) return;
                const x1 = b1.x + b1.w/2, y1 = b1.y + b1.h/2, x2 = b2.x + b2.w/2, y2 = b2.y + b2.h/2;
                const line = document.createElementNS("http://www.w3.org/2000/svg", "path");
                line.setAttribute("d", `M ${x1} ${y1} L ${x2} ${y2}`);
                line.setAttribute("class", "connector-line");
                svg.appendChild(line);
            });
        }
        function deleteSelected() { if (!selectedId) return; boxes = boxes.filter(b => b.id !== selectedId); connections = connections.filter(c => c.from !== selectedId && c.to !== selectedId); document.getElementById(selectedId).remove(); selectedId = null; updateConnections(); saveState(); }
        function updateContent(id, html) { const box = boxes.find(b => b.id === id); if (box) { box.content = html; clearTimeout(window.saveTimeout); window.saveTimeout = setTimeout(saveState, 1000); } }
        function triggerFile() { document.getElementById('file-input').click(); }
        function handleFile(e) {
            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                const content = file.type.startsWith('image/') ? `<img src="${ev.target.result}" class="rounded-lg w-full h-auto pointer-events-none">` : `<div class="bg-slate-50 p-4 rounded-xl flex items-center gap-3 border border-slate-100"> <div class="w-10 h-10 bg-emerald-100 text-emerald-600 rounded-lg flex items-center justify-center"><i data-lucide="file" class="w-5 h-5"></i></div> <div class="overflow-hidden"><p class="text-xs font-bold text-slate-700 truncate">${file.name}</p><p class="text-[10px] text-slate-400 uppercase font-black">Allegato</p></div> </div>`;
                addBox('media', 300, 300, content);
            };
            reader.readAsDataURL(file);
        }
        let timerSeconds = 0, timerInterval = null;
        function toggleTimer() { const btn = document.getElementById('timer-btn'); if (timerInterval) { clearInterval(timerInterval); timerInterval = null; btn.innerHTML = '<i data-lucide="play" class="w-5 h-5"></i>'; btn.classList.replace('bg-rose-500', 'bg-emerald-500'); } else { timerInterval = setInterval(() => { timerSeconds++; updateTimerDisplay(); }, 1000); btn.innerHTML = '<i data-lucide="pause" class="w-5 h-5"></i>'; btn.classList.replace('bg-emerald-500', 'bg-rose-500'); } lucide.createIcons(); }
        function resetTimer() { clearInterval(timerInterval); timerInterval = null; timerSeconds = 0; updateTimerDisplay(); const btn = document.getElementById('timer-btn'); btn.innerHTML = '<i data-lucide="play" class="w-5 h-5"></i>'; btn.classList.add('bg-emerald-500'); btn.classList.remove('bg-rose-500'); lucide.createIcons(); }
        function updateTimerDisplay() { const m = Math.floor(timerSeconds/60).toString().padStart(2,'0'), s = (timerSeconds%60).toString().padStart(2,'0'); document.getElementById('timer-display').innerText = `${m}:${s}`; }

        async function saveState() { 
            const state = { boxes, connections };
            localStorage.setItem('dash_state_stable', JSON.stringify(state)); 
            try { await fetch(SYNC_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(state) }); } catch (err) {}
        }
        function loadState() { const saved = localStorage.getItem('dash_state_stable'); if (saved) { applyState(JSON.parse(saved)); } }
        function applyState(data) {
            boxes = data.boxes || []; connections = data.connections || [];
            const ids = boxes.map(b => b.id);
            document.querySelectorAll('.dash-box').forEach(el => { if (!ids.includes(el.id)) el.remove(); });
            boxes.forEach(renderBox); updateConnections();
        }
        async function startPolling() {
            setInterval(async () => {
                if (dragInfo || resizeInfo || isDrawing) return;
                try {
                    const res = await fetch(SYNC_URL);
                    if (res.ok) { const data = await res.json(); if (data.lastUpdate > lastSyncTime) { applyState(data); lastSyncTime = data.lastUpdate; } }
                } catch (err) {}
            }, 3000); 
        }
    </script>
</body>
</html>